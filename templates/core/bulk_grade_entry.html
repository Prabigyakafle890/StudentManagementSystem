{% extends 'base.html' %}
{% load static %}
{% load core_filters %}

{% block title %}Bulk Grade Entry - {{ course.name }} - EduManager{% endblock %}

{% block extra_css %}
<style>
    .bulk-entry-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    .bulk-entry-card .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        border: none;
    }
    .student-row {
        border-bottom: 1px solid #dee2e6;
        padding: 15px 0;
        transition: background-color 0.3s;
    }
    .student-row:hover {
        background-color: #f8f9fa;
    }
    .marks-input {
        width: 100px;
        text-align: center;
    }
    .grade-select {
        width: 120px;
    }
    .btn-save-all {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        border: none;
        border-radius: 10px;
        padding: 15px 40px;
        font-size: 1.1rem;
        font-weight: bold;
    }
    .existing-grade {
        background-color: #e3f2fd;
        border: 2px solid #2196f3;
    }
    .grade-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }
    .grade-a { background-color: #28a745; color: white; }
    .grade-b { background-color: #007bff; color: white; }
    .grade-c { background-color: #ffc107; color: black; }
    .grade-d { background-color: #fd7e14; color: white; }
    .grade-f { background-color: #dc3545; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-users"></i> Bulk Grade Entry</h1>
                <a href="{% url 'grade_entry' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Grade Entry
                </a>
            </div>
            
            <div class="bulk-entry-card card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-book"></i> {{ course.name }} ({{ course.code }})
                        <span class="badge bg-light text-dark ms-2">{{ students|length }} Students</span>
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Instructions:</strong> Enter marks (0-100) for each student. The grade will be calculated automatically. 
                        Students with existing grades are highlighted in blue.
                    </div>
                    
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <strong>Student ID</strong>
                            </div>
                            <div class="col-md-4">
                                <strong>Student Name</strong>
                            </div>
                            <div class="col-md-2">
                                <strong>Marks</strong>
                            </div>
                            <div class="col-md-2">
                                <strong>Grade</strong>
                            </div>
                            <div class="col-md-1">
                                <strong>Current</strong>
                            </div>
                        </div>
                        
                        {% for student in students %}
                        <div class="student-row row {% if student.id in existing_grades %}existing-grade{% endif %}">
                            <div class="col-md-3">
                                <span class="fw-bold">{{ student.student_id }}</span>
                            </div>
                            <div class="col-md-4">
                                <span>{{ student.name }}</span>
                                <br>
                                <small class="text-muted">{{ student.email }}</small>
                            </div>
                            <div class="col-md-2">
                                <input type="number" 
                                       name="marks_{{ student.id }}" 
                                       class="form-control marks-input" 
                                       min="0" 
                                       max="100" 
                                       step="0.1"
                                       placeholder="0-100"
                                       {% if student.id in existing_grades %}
                                       value="{{ existing_grades|get_grade_marks:student.id }}"
                                       {% endif %}
                                       onchange="calculateGrade(this, {{ student.id }})">
                            </div>
                            <div class="col-md-2">
                                <select name="grade_{{ student.id }}" 
                                        class="form-select grade-select" 
                                        id="grade_{{ student.id }}">
                                    <option value="">-</option>
                                    <option value="A+">A+ (95-100)</option>
                                    <option value="A">A (90-94)</option>
                                    <option value="A-">A- (85-89)</option>
                                    <option value="B+">B+ (80-84)</option>
                                    <option value="B">B (75-79)</option>
                                    <option value="B-">B- (70-74)</option>
                                    <option value="C+">C+ (65-69)</option>
                                    <option value="C">C (60-64)</option>
                                    <option value="C-">C- (55-59)</option>
                                    <option value="D">D (50-54)</option>
                                    <option value="F">F (0-49)</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                {% if student.id in existing_grades %}
                                    <span class="grade-badge grade-{{ existing_grades|get_grade_letter:student.id|first|lower }}">
                                        {{ existing_grades|get_grade_letter:student.id }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-users-slash fa-3x mb-3"></i>
                            <h5>No students enrolled in this course</h5>
                            <p>Please ensure students are enrolled before entering grades.</p>
                        </div>
                        {% endfor %}
                        
                        {% if students %}
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-save-all">
                                <i class="fas fa-save"></i> Save All Grades
                            </button>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function calculateGrade(marksInput, studentId) {
        const marks = parseFloat(marksInput.value);
        const gradeSelect = document.getElementById(`grade_${studentId}`);
        
        if (!isNaN(marks)) {
            let grade;
            if (marks >= 95) grade = 'A+';
            else if (marks >= 90) grade = 'A';
            else if (marks >= 85) grade = 'A-';
            else if (marks >= 80) grade = 'B+';
            else if (marks >= 75) grade = 'B';
            else if (marks >= 70) grade = 'B-';
            else if (marks >= 65) grade = 'C+';
            else if (marks >= 60) grade = 'C';
            else if (marks >= 55) grade = 'C-';
            else if (marks >= 50) grade = 'D';
            else grade = 'F';
            
            gradeSelect.value = grade;
            
            // Add visual feedback
            marksInput.style.borderColor = '#28a745';
            gradeSelect.style.borderColor = '#28a745';
        } else {
            gradeSelect.value = '';
            marksInput.style.borderColor = '';
            gradeSelect.style.borderColor = '';
        }
    }

    // Auto-fill all grades when marks are entered
    document.addEventListener('DOMContentLoaded', function() {
        // Load existing grades
        {% for student in students %}
            {% if student.id in existing_grades %}
                const gradeSelect{{ student.id }} = document.getElementById('grade_{{ student.id }}');
                if (gradeSelect{{ student.id }}) {
                    gradeSelect{{ student.id }}.value = '{{ existing_grades|get_grade_letter:student.id }}';
                }
            {% endif %}
        {% endfor %}
        
        // Confirm before leaving if there are unsaved changes
        let hasChanges = false;
        const inputs = document.querySelectorAll('input[type="number"], select');
        inputs.forEach(input => {
            input.addEventListener('change', () => {
                hasChanges = true;
            });
        });
        
        window.addEventListener('beforeunload', function(e) {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
        
        // Clear changes flag on form submit
        document.querySelector('form').addEventListener('submit', () => {
            hasChanges = false;
        });
    });
</script>
{% endblock %}